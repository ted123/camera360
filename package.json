{
  "name": "recordrtc-nodejs",
  "preferGlobal": true,
  "version": "1.0.0",
  "author": {
    "name": "Muaz Khan",
    "email": "muazkh@gmail.com"
  },
  "description": "Records audio/video separately as wav/webm. POST both files in single HttpPost-Request to Node.js (FormData). Node.js code saves both files into disk. Node.js code invokes ffmpeg to merge wav/webm in single webm file. The merged webm file's URL is returned using same HTTP-callback for playback!",
  "contributors": [
    {
      "name": "Muaz Khan",
      "email": "muazkh@gmail.com"
    }
  ],
  "scripts": {
    "start": "node index.js"
  },
  "main": "./index.js",
  "repository": {
    "type": "git",
    "url": "https://github.com/muaz-khan/WebRTC-Experiment.git"
  },
  "keywords": [
    "webrtc",
    "javascript",
    "RecordRTC",
    "Node.js",
    "ffmpeg",
    "audio-recording",
    "video-recording",
    "gif-recording",
    "audio/video recording",
    "webp",
    "webm",
    "wav"
  ],
  "analyze": false,
  "license": "MIT",
  "engines": {
    "node": ">=0.6"
  },
  "readmeFilename": "README.md",
  "bugs": {
    "url": "https://github.com/muaz-khan/WebRTC-Experiment/issues"
  },
  "homepage": "https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-to-Nodejs",
  "_id": "recordrtc-nodejs@1.0.0",
  "_from": "recordrtc-nodejs@",
  "readme": "#### [RecordRTC to Node.js](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-to-Nodejs)\r\n\r\n<a href=\"https://nodei.co/npm/recordrtc-nodejs/\">\r\n    <img src=\"https://nodei.co/npm/recordrtc-nodejs.png\">\r\n</a>\r\n\r\n```\r\nnpm install recordrtc-nodejs\r\n\r\n// to run it!\r\nnode ./node_modules/recordrtc-nodejs/index.js\r\n```\r\n\r\n=\r\n\r\n##### How to test?\r\n\r\nIn the node.js command prompt window; type `node index`; then open `http://localhost:8000/`.\r\n\r\n=\r\n\r\nThere are some other NPM packages regarding RecordRTC:\r\n\r\n* https://www.npmjs.org/search?q=RecordRTC\r\n\r\n=\r\n\r\n**Make sure that directory names MUST NOT have spaces; e.g.**\r\n\r\n```\r\n// invalid directory\r\nC:\\Hello Sir\\Another\\RecordRTC\r\n\r\n// valid\r\nC:\\Hello-Sir\\Another\\RecordRTC\r\n\r\n// invalid directory\r\nC:\\First\\Second Dir\\Third\\RecordRTC\r\n\r\n// valid\r\nC:\\\\First\\Second-Dir\\Third\\RecordRTC\r\n```\r\n\r\nThis experiment:\r\n\r\n1. Records audio/video separately as wav/webm\r\n2. POST both files in single HttpPost-Request to Node.js (FormData)\r\n3. Node.js code saves both files into disk\r\n4. Node.js code invokes ffmpeg to merge wav/webm in single \"webm\" file\r\n5. The merged webm file's URL is returned using same HTTP-callback for playback!\r\n\r\n=\r\n\r\n##### Windows Batch File (`merger.bat`)\r\n\r\n`merger.bat` file is executed to invoke ffmpeg functionalities on windows:\r\n\r\n```\r\n@echo off\r\n\"C:\\ffmpeg\\bin\\ffmpeg.exe\" -i %1 -itsoffset -00:00:01 -i %2 %3\r\n```\r\n\r\n**It is assumed that you already have installed ffmpeg on your system.** Though, EXE file is hard-coded to \"C:\\ffmpeg\\bin\\ffmpeg.exe\" however you can easily edit it according to your own installations.\r\n\r\n=\r\n\r\n##### `.sh` file\r\n\r\n`merger.sh` file is executed to invoke ffmpeg functionalities on Mac/Linux/etc.\r\n\r\n```\r\nffmpeg -i audio-file.wav -itsoffset -00:00:01 -i video-file.webm -map 0:0 -map 1:0 output-file-name.webm\r\n```\r\n\r\nUsing Linux; ffmpeg installation is super-easy! You can install DEVEL packages as well.\r\n\r\n=\r\n\r\n##### How to install ffmpeg on windows?\r\n\r\n1. Download ffmpeg and extract ZIP file\r\n2. Rename extracted directory to \"ffmpeg\"\r\n3. Right click over \"My Computer\" icon and select \"Properties\" context-menu option\r\n4. Select \"Advance system settings\" from top-left section\r\n5. Click \"Environment Variables...\" button from \"Advanced\" tab\r\n6. Click \"New...\" button and in the \"Variable name\" box, enter \"Path\".\r\n7. In the \"Variable value\" box, enter extracted directory full URI e.g. \"C:\\ffmpeg\"\r\n8. Click \"OK\" and done!\r\n\r\nhttp://www.wikihow.com/Install-FFmpeg-on-Windows\r\n\r\n=\r\n\r\n##### How to install ffmpeg on Mac OSX?\r\n\r\nMake sure you have **homebrew** installed. Then run following command:\r\n\r\n```\r\nbrew install ffmpeg --with-libvpx --with-theora --whit-libogg --with-libvorbis\r\n```\r\n\r\n=\r\n\r\n##### `index.html`\r\n\r\n```html\r\n<!--\r\n// Muaz Khan     - www.MuazKhan.com\r\n// MIT License   - www.WebRTC-Experiment.com/licence\r\n// Experiments   - github.com/muaz-khan/WebRTC-Experiment\r\n-->\r\n\r\n<!DOCTYPE html>\r\n<html>\r\n    <head>\r\n        <meta charset=\"utf-8\" />\r\n        <title>RecordRTC over Node.js</title>\r\n        <script>\r\n            if (location.href.indexOf('file:') == 0) {\r\n                document.write('<h1 style=\"color:red;\">Please load this HTML file on HTTP or HTTPS.</h1>');\r\n            }\r\n        </script>\r\n        <meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\" />\r\n        <link rel=\"author\" type=\"text/html\" href=\"https://plus.google.com/+MuazKhan\">\r\n        <meta name=\"author\" content=\"Muaz Khan\">\r\n        <script src=\"https://www.webrtc-experiment.com/RecordRTC.js\"> </script>\r\n        <style>\r\n            html { background-color: #f7f7f7; }\r\n\r\n            body {\r\n                background-color: white;\r\n                border: 1px solid rgb(15, 158, 238);\r\n                margin: 1% 35%;\r\n                text-align: center;\r\n            }\r\n\r\n            hr {\r\n                border: 0;\r\n                border-top: 1px solid rgb(15, 158, 238);\r\n            }\r\n\r\n            a {\r\n                color: #2844FA;\r\n                text-decoration: none;\r\n            }\r\n\r\n            a:hover, a:focus { color: #1B29A4; }\r\n\r\n            a:active { color: #000; }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <p>\r\n            <video id=\"camera-preview\" controls style=\"border: 1px solid rgb(15, 158, 238); width: 94%;\"></video> \r\n        </p><hr />\r\n\r\n        <div>\r\n            <button id=\"start-recording\">Start Recording</button>\r\n            <button id=\"stop-recording\" disabled=\"\">Stop Recording</button>\r\n        </div>\r\n\t\t\r\n        <script>\r\n            var startRecording = document.getElementById('start-recording');\r\n            var stopRecording = document.getElementById('stop-recording');\r\n            var cameraPreview = document.getElementById('camera-preview');\r\n\r\n            var audio = document.querySelector('audio');\r\n\r\n            var isFirefox = !!navigator.mozGetUserMedia;\r\n\r\n            var recordAudio, recordVideo;\r\n            startRecording.onclick = function() {\r\n                startRecording.disabled = true;\r\n                navigator.getUserMedia({\r\n                        audio: true,\r\n                        video: true\r\n                    }, function(stream) {\r\n                        cameraPreview.src = window.URL.createObjectURL(stream);\r\n                        cameraPreview.play();\r\n\r\n                        recordAudio = RecordRTC(stream, {\r\n                            bufferSize: 16384\r\n                        });\r\n\r\n                        if (!isFirefox) {\r\n                            recordVideo = RecordRTC(stream, {\r\n                                type: 'video'\r\n                            });\r\n                        }\r\n\r\n                        recordAudio.startRecording();\r\n\r\n                        if (!isFirefox) {\r\n                            recordVideo.startRecording();\r\n                        }\r\n\r\n                        stopRecording.disabled = false;\r\n                    }, function(error) {\r\n                        alert(JSON.stringify(error));\r\n                    });\r\n            };\r\n\r\n\r\n            stopRecording.onclick = function() {\r\n                startRecording.disabled = false;\r\n                stopRecording.disabled = true;\r\n\r\n                recordAudio.stopRecording(function() {\r\n                    if (isFirefox) onStopRecording();\r\n                });\r\n\r\n                if (!isFirefox) {\r\n                    recordVideo.stopRecording();\r\n                    onStopRecording();\r\n                }\r\n\r\n                function onStopRecording() {\r\n                    recordAudio.getDataURL(function(audioDataURL) {\r\n                        if (!isFirefox) {\r\n                            recordVideo.getDataURL(function(videoDataURL) {\r\n                                postFiles(audioDataURL, videoDataURL);\r\n                            });\r\n                        } else postFiles(audioDataURL);\r\n                    });\r\n                }\r\n            };\r\n\r\n            var fileName;\r\n\r\n            function postFiles(audioDataURL, videoDataURL) {\r\n                fileName = getRandomString();\r\n                var files = { };\r\n\r\n                files.audio = {\r\n                    name: fileName + (isFirefox ? '.webm' : '.wav'),\r\n                    type: isFirefox ? 'video/webm' : 'audio/wav',\r\n                    contents: audioDataURL\r\n                };\r\n\r\n                if (!isFirefox) {\r\n                    files.video = {\r\n                        name: fileName + '.webm',\r\n                        type: 'video/webm',\r\n                        contents: videoDataURL\r\n                    };\r\n                }\r\n\r\n                files.isFirefox = isFirefox;\r\n\r\n                cameraPreview.src = '';\r\n                cameraPreview.poster = '/ajax-loader.gif';\r\n\r\n                xhr('/upload', JSON.stringify(files), function(_fileName) {\r\n                    var href = location.href.substr(0, location.href.lastIndexOf('/') + 1);\r\n                    cameraPreview.src = href + 'uploads/' + _fileName;\r\n                    cameraPreview.play();\r\n\r\n                    var h2 = document.createElement('h2');\r\n                    h2.innerHTML = '<a href=\"' + cameraPreview.src + '\">' + cameraPreview.src + '</a>';\r\n                    document.body.appendChild(h2);\r\n                });\r\n            }\r\n\r\n            function xhr(url, data, callback) {\r\n                var request = new XMLHttpRequest();\r\n                request.onreadystatechange = function() {\r\n                    if (request.readyState == 4 && request.status == 200) {\r\n                        callback(request.responseText);\r\n                    }\r\n                };\r\n                request.open('POST', url);\r\n                request.send(data);\r\n            }\r\n\r\n            window.onbeforeunload = function() {\r\n                startRecording.disabled = false;\r\n            };\r\n\r\n            function getRandomString() {\r\n                if (window.crypto) {\r\n                    var a = window.crypto.getRandomValues(new Uint32Array(3)),\r\n                        token = '';\r\n                    for (var i = 0, l = a.length; i < l; i++) token += a[i].toString(36);\r\n                    return token;\r\n                } else {\r\n                    return (Math.random() * new Date().getTime()).toString(36).replace( /\\./g , '');\r\n                }\r\n            }\r\n        </script>\r\n    </body>\r\n</html>\r\n```\r\n\r\n=\r\n\r\n##### `handlers.js`\r\n\r\n```javascript\r\nvar config = require('./config'),\r\n    fs = require('fs'),\r\n    sys = require('sys'),\r\n    exec = require('child_process').exec;\r\n\r\nfunction home(response) {\r\n    response.writeHead(200, {\r\n        'Content-Type': 'text/html'\r\n    });\r\n    response.end(fs.readFileSync('./static/index.html'));\r\n}\r\n\r\n// this function uploads files\r\n\r\nfunction upload(response, postData) {\r\n    var files = JSON.parse(postData);\r\n\r\n    // writing audio file to disk\r\n    _upload(response, files.audio);\r\n\r\n    if (files.isFirefox) {\r\n        response.statusCode = 200;\r\n        response.writeHead(200, { 'Content-Type': 'application/json' });\r\n        response.end(files.audio.name);\r\n    }\r\n\r\n    if (!files.isFirefox) {\r\n        // writing video file to disk\r\n        _upload(response, files.video);\r\n\r\n        merge(response, files);\r\n    }\r\n}\r\n\r\n// this function merges wav/webm files\r\n\r\nfunction merge(response, files) {\r\n    // detect the current operating system\r\n    var isWin = !!process.platform.match( /^win/ );\r\n\r\n    if (isWin) {\r\n        ifWin(response, files);\r\n    } else {\r\n        ifMac(response, files);\r\n    }\r\n}\r\n\r\nfunction _upload(response, file) {\r\n    var fileRootName = file.name.split('.').shift(),\r\n        fileExtension = file.name.split('.').pop(),\r\n        filePathBase = config.upload_dir + '/',\r\n        fileRootNameWithBase = filePathBase + fileRootName,\r\n        filePath = fileRootNameWithBase + '.' + fileExtension,\r\n        fileID = 2,\r\n        fileBuffer;\r\n\r\n    while (fs.existsSync(filePath)) {\r\n        filePath = fileRootNameWithBase + '(' + fileID + ').' + fileExtension;\r\n        fileID += 1;\r\n    }\r\n\r\n    file.contents = file.contents.split(',').pop();\r\n\r\n    fileBuffer = new Buffer(file.contents, \"base64\");\r\n\r\n    fs.writeFileSync(filePath, fileBuffer);\r\n}\r\n\r\nfunction serveStatic(response, pathname) {\r\n\r\n    var extension = pathname.split('.').pop(),\r\n        extensionTypes = {\r\n            'js': 'application/javascript',\r\n            'webm': 'video/webm',\r\n            'gif': 'image/gif'\r\n        };\r\n\r\n    response.writeHead(200, {\r\n        'Content-Type': extensionTypes[extension]\r\n    });\r\n    if (extensionTypes[extension] == 'video/webm')\r\n        response.end(fs.readFileSync('.' + pathname));\r\n    else\r\n        response.end(fs.readFileSync('./static' + pathname));\r\n}\r\n\r\nfunction ifWin(response, files) {\r\n    // following command tries to merge wav/webm files using ffmpeg\r\n    var merger = __dirname + '\\\\merger.bat';\r\n    var audioFile = __dirname + '\\\\uploads\\\\' + files.audio.name;\r\n    var videoFile = __dirname + '\\\\uploads\\\\' + files.video.name;\r\n    var mergedFile = __dirname + '\\\\uploads\\\\' + files.audio.name.split('.')[0] + '-merged.webm';\r\n\r\n    // if a \"directory\" has space in its name; below command will fail\r\n    // e.g. \"c:\\\\dir name\\\\uploads\" will fail.\r\n    // it must be like this: \"c:\\\\dir-name\\\\uploads\"\r\n    var command = merger + ', ' + audioFile + \" \" + videoFile + \" \" + mergedFile + '';\r\n    exec(command, function (error, stdout, stderr) {\r\n        if (error) {\r\n            console.log(error.stack);\r\n            console.log('Error code: ' + error.code);\r\n            console.log('Signal received: ' + error.signal);\r\n        } else {\r\n            response.statusCode = 200;\r\n            response.writeHead(200, {\r\n                'Content-Type': 'application/json'\r\n            });\r\n            response.end(files.audio.name.split('.')[0] + '-merged.webm');\r\n\r\n            fs.unlink(audioFile);\r\n            fs.unlink(videoFile);\r\n        }\r\n    });\r\n}\r\n\r\nfunction ifMac(response, files) {\r\n    // its probably *nix, assume ffmpeg is available\r\n    var audioFile = __dirname + '/uploads/' + files.audio.name;\r\n    var videoFile = __dirname + '/uploads/' + files.video.name;\r\n    var mergedFile = __dirname + '/uploads/' + files.audio.name.split('.')[0] + '-merged.webm';\r\n    var util = require('util'),\r\n        exec = require('child_process').exec;\r\n    //child_process = require('child_process');\r\n\r\n    var command = \"ffmpeg -i \" + audioFile + \" -itsoffset -00:00:01 -i \" + videoFile + \" -map 0:0 -map 1:0 \" + mergedFile;\r\n\r\n    exec(command, function (error, stdout, stderr) {\r\n        if (stdout) console.log(stdout);\r\n        if (stderr) console.log(stderr);\r\n\r\n        if (error) {\r\n            console.log('exec error: ' + error);\r\n            response.statusCode = 404;\r\n            response.end();\r\n\r\n        } else {\r\n            response.statusCode = 200;\r\n            response.writeHead(200, {\r\n                'Content-Type': 'application/json'\r\n            });\r\n            response.end(files.audio.name.split('.')[0] + '-merged.webm');\r\n\r\n            // removing audio/video files\r\n            fs.unlink(audioFile);\r\n            fs.unlink(videoFile);\r\n        }\r\n\r\n    });\r\n}\r\n\r\nexports.home = home;\r\nexports.upload = upload;\r\nexports.serveStatic = serveStatic;\r\n```\r\n\r\n=\r\n\r\n1. [RecordRTC to Node.js](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-to-Nodejs)\r\n2. [RecordRTC to PHP](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-to-PHP)\r\n3. [RecordRTC to ASP.NET MVC](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-to-ASPNETMVC)\r\n4. [RecordRTC & HTML-2-Canvas i.e. Canvas/HTML Recording!](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/Canvas-Recording)\r\n5. [MRecordRTC i.e. Multi-RecordRTC!](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/MRecordRTC)\r\n6. [RecordRTC on Ruby!](https://github.com/cbetta/record-rtc-experiment)\r\n7. [RecordRTC over Socket.io](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-over-Socketio)\r\n\r\n=\r\n\r\n##### License\r\n\r\n[RecordRTC-to-Nodejs](https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RecordRTC/RecordRTC-to-Nodejs) is released under [MIT licence](https://www.webrtc-experiment.com/licence/) . Copyright (c) [Muaz Khan](https://plus.google.com/+MuazKhan).\r\n",
  "_shasum": "68c0539bef6de97fe04a2d92ef8dca1c3f21b727",
  "_resolved": "https://registry.npmjs.org/recordrtc-nodejs/-/recordrtc-nodejs-1.0.0.tgz"
}
